<!DOCTYPE html>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<h1>IL Pension Viz</h1>


<div id="filter">
	<b>Fund Name:</b>
</div>

<div id ="graph">
<svg width="960" height="500"></svg>
</div>

<script>


var x = d3.scaleLinear()
	.rangeRound([0,width]);
	
var y = d3.scaleLinear()
    .rangeRound([height, 0]);

var valueLine = d3.line()
    .x(function(d) { return d.Year; })
    .y(function(d) { return y(d.Funding); });
	
				
var svg = d3.select("#graph").append("svg"),
    margin = {top: 20, right: 20, bottom: 30, left: 50},
    width = +svg.attr("width") - margin.left - margin.right,
    height = +svg.attr("height") - margin.top - margin.bottom,
    g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
	
//Bring in Data, do everything that is data-driven
d3.csv("https://geoffsegal.github.io/IL-Pension/data/totalpensiondata.csv", function(d) {
	
		d.Active_Female = +d.Active_Female;
		d.Active_Male = +d.Active_Male;
		d.Active_Members = +d.Active_Members;
		d.Assets = +d.Assets
		d.Funding = +d.Funding
		d.Liabilities = +d.Liabilities
		d.Position = +d.Position
		d.Retired_Members = +d.Retired_Members
		d.Year = +d.Year
	
   
   return d;
   

}, function(error,data) {
	if (error) throw error;
	
	var nest = d3.nest()
		.key(function(d){
			return d.Fund_Name;
		})
		.key(function(d) {
			return d.Year;
		})
		.entries(data)

  x.domain(d3.extent(data, function(d) { return d.Year; }));
  y.domain(d3.extent(data, function(d) { return d.Funding; }));

  g.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x))
    .select(".domain")
      .remove();

  g.append("g")
      .call(d3.axisLeft(y))
    .append("text")
      .attr("fill", "#000")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", "0.71em")
      .attr("text-anchor", "end")
      .text("Funding");
	  
	  var options = d3.select("#filter")
	  
	  options
		.append("select")
		.selectAll("option")
		.data(nest)
		.enter()
		.append("option")
		.attr("value",function(d) {
			return d.key;
		})
		.text(function(d){
			return d.key;
		})
		
var initialGraph = function(fund) {

	var selectFund = nest.filter(function(d) { return d.key == fund;})
	
	var selectedFunds = svg.selectAll(".funds")
		.data(selectFund, function(d) { return d ? d.key: this.key;})
		.enter()
		.append("g")
		.attr("class", "funds")
	
	var initialPath = selectedFunds.selectAll(".line")
		.data(function(d) { return (d.values);})
		.enter()
		 .append("path")
	initialPath
		 .attr("d", function(d) { return valueLine(d.values)})
		 .attr("class","line")
}

initialGraph("ALGONQUIN POLICE PENSION FUND")

var updateGraph = function(fund) {
	var selectFund = nest.filter(function(d) {
	return d.key == fund;
	})
	var selectedFunds = svg.selectAll(".funds")
		.data(selectFund)
	selectedFunds.selectAll("path.line")
		.data(function(d) { return (d.values);})
		.transition()
		 .duration(1000)
		 .attr("d", function(d) { return valueLine(d.values)
		 })
}

options.on('change', function() {
	var selectedFund = d3.select(this)
						.select("select")
						.property("value")
						
	updateGraph(selectedFund)
	});


//g.append("path")
 //     .datum(data)
   //   .attr("fill", "none")
     // .attr("stroke", "steelblue")
      //.attr("stroke-linejoin", "round")
      //.attr("stroke-linecap", "round")
      //.attr("stroke-width", 1.5)
      //.attr("d", line);
	  
	//var options = dropDown.selectAll("option")
		//				.data(data)
			//			.enter()
				//		.append("option");
	//options.text(function(d) {return d.Fund_Name; });
	
	//dropDown.on("change", function() {
      //var selected = this.value;
      //var fdata = filteredData(selected)
	  //d3.select('#svg').selectAll(*).remove();
	  //makeGraph('#svg',fdata);
		
});

</script>